#! /usr/bin/env perl
use warnings;
use strict;

use FindBin '$Bin';
use lib "$Bin/../lib";

use Test::More;

use QBitcoin::Config;
use QBitcoin::Const;
use QBitcoin::Script::OpCodes qw(:OPCODES);
use QBitcoin::Script qw(script_eval op_pushdata);
use QBitcoin::Crypto qw(signature hash256 generate_keypair pk_import check_sig);
use QBitcoin::Crypto::PQ::Falcon512;
use QBitcoin::Address qw(wallet_import_format wif_to_pk);
use QBitcoin::MyAddress;

my $pk = generate_keypair(CRYPT_ALGO_FALCON);
ok(QBitcoin::Crypto::PQ::Falcon512->is_valid_pk($pk->pk_serialize), "falcon generated key valid");
my $myaddr = QBitcoin::MyAddress->new( private_key => wallet_import_format($pk->pk_serialize) );
my $sign_data = "\x55\xaa" x 700;
my $redeem_script = OP_DUP . OP_HASH256 . op_pushdata(hash256($myaddr->pubkey)) . OP_EQUALVERIFY . OP_CHECKSIG;
my $signature = signature($sign_data, $myaddr, CRYPT_ALGO_FALCON, SIGHASH_ALL);
my $siglist = [ $signature, $myaddr->pubkey ];
my $tx = TestTx->new(sign_data => $sign_data);
my $res = script_eval($siglist, $redeem_script, $tx, 0);
ok($res, "checksig");
my $pk2 = generate_keypair(CRYPT_ALGO_FALCON);
my $myaddr2 = QBitcoin::MyAddress->new( private_key => wallet_import_format($pk2->pk_serialize) );
my $siglist2 = [ $signature, $myaddr2->pubkey ];
$res = script_eval($siglist2, $redeem_script, $tx, 0);
ok(!$res, "checksig (incorrect pubkey)");
my $signature2 = signature($sign_data, $myaddr2, CRYPT_ALGO_FALCON, SIGHASH_ALL);
my $siglist3 = [ $signature2, $myaddr->pubkey ];
$res = script_eval($siglist3, $redeem_script, $tx, 0);
ok(!$res, "checksig (incorrect signature)");

my $private_key = "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";
my $sign = "813961c32c0fcc6132c89b74f34894091d4d598c53d284597e7fcf2bace22a41460fb99436f82c151b73836a237a164acde34ff0080eee10be36bcc8545168c22d99deca8d0e25c8e7732f51c419679e05c19670c8497a9760670e3b07f88ad2f850abe77243c0d495f5bf9265a5d887af8da8705712417adee252d1911aebae398f42e9059e7deaec77c87f6648400e2e0115c3891bd71da1c18c1acdcafc5f6b52a6cd929e191546cea1dc22383f44f22b45da68323e8912d994e1c3f2aa4d0dae68358eb1e773f7a99d8babc6954bd1fa03a7d1475fae6542dff0efeedf4fb481706ae35f328b44435b6e124de7d510cb6dcb8ca9e8130712171021e959a542d6a44b759643a8ccc3f32a6a6b1da9aaf4bf5e5a7625b877b208da9c7915aa4f70cff19e475a1e8edc546464ab12f8eeb509b0996c72f1173d8fdebb6102294d833d3cfa3e0bac1378c68cb5271492c85f47cf6e61312ad73c468d013172312771509dd3a26a0511f0b56b86f35a92b950de779525b7b96b1105fec1f35f0cbd362708fcd9b273578530483632c98936939954e6c3f0a0ece0ac7af99b814ec838ffd0464348a05a71e536778358555cb9ba444d32fd3a711a64417080fedbc3facad575c4ca81b3a7a755ea74579977b3d454adf7e0d0d577b11edd6f5aae3105c7796f5418febf4a1692bea6a4678e62af16ce9bc8a118adaa6b52c68ee5513b00c6b2f0620133346ccd85387cf32fbf5ea9a449684645d9dfe65a59732465081045f2736e1bc9b9f5fa06a095676d26cd706ce4ee8fb6dedab308be4b8f6651137728c6e439fb8359c0d2a1397cb24cc899fd5532b3a5b8bf792890b2a1426bffd13a113d3989db5be80a3fd7b4c234031ecfd112ae556682d9cc696cc3a8a3956419ae991bb40aa8aba7fbe7659b92c0";
my $pk1 = pk_import(wif_to_pk($private_key), CRYPT_ALGO_FALCON);
ok(check_sig($sign_data, pack("H*", $sign), $pk1->pubkey_by_privkey), "falcon signature verification");
done_testing();

package TestTx;
use warnings;
use strict;

use QBitcoin::Accessors qw(new);
sub sign_data { $_[0]->{sign_data} };

1;
